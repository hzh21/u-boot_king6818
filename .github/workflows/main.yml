name: Build King6818 U-Boot
on: 
  push:
    branches: [ main, master ]
  workflow_dispatch: # 允许手动触发编译

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-arm-linux-gnueabi \
            gcc-aarch64-linux-gnu \
            make bc device-tree-compiler \
            libssl-dev \
            libgnutls28-dev \
            uuid-dev \
            python3-dev \
            swig \
            pkg-config

      - name: Configure U-Boot
        run: |
          # 使用针对 GEC6818 适配的配置文件
          make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- s5p6818_gec6818_defconfig

      - name: Compile U-Boot
        run: |
          # 核心编译步骤：
          # 1. 使用 32 位交叉编译器（S5P6818 U-Boot 虽引导 64 位，但自身多为 32 位编译）
          # 2. KCFLAGS 忽略部分现代编译器产生的警告，防止报错中断
          make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- KCFLAGS="-Wno-error" -j$(nproc)

      - name: Package FIP (NISH + 2ndboot)
        run: |
          # 检查仓库中是否存在打包脚本
          if [ -f "./make_fip.sh" ]; then
            chmod +x ./make_fip.sh
            ./make_fip.sh
          elif [ -f "./fusing.sh" ]; then
            chmod +x ./fusing.sh
            ./fusing.sh
          else
            echo "Warning: Packing script not found, only raw u-boot.bin will be available."
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: King6818-Uboot-Output
          path: |
            u-boot.bin
            fip-nonsecure.img
            *uboot*
