name: Build King6818 U-Boot
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-arm-linux-gnueabi \
            gcc-aarch64-linux-gnu \
            make bc device-tree-compiler \
            libssl-dev libgnutls28-dev uuid-dev python3-dev swig pkg-config

      - name: Configure U-Boot
        run: |
          # 保持使用 arm 架构配置
          make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- s5p6818_gec6818_defconfig

      - name: Compile U-Boot
        run: |
          # 关键修改：通过 KCFLAGS 强制编译器支持 ARMv8 指令集描述
          # 解决 CurrentEL 和 sctlr_el1 无法识别的问题
          make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- \
               KCFLAGS="-march=armv8-a -Wno-error" \
               -j$(nproc)

      - name: Package FIP
        run: |
          if [ -f "./make_fip.sh" ]; then
            chmod +x ./make_fip.sh
            ./make_fip.sh
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: King6818-Uboot-Fixed
          path: |
            u-boot.bin
            fip-nonsecure.img
